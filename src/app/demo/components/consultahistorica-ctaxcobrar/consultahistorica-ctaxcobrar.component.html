<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="container">
    <p-panel header="Consulta Doc.Histórico - Ctaxcobrar" class="mb-3">
        <p-breadcrumb [model]="items" class="max-w-full;"></p-breadcrumb>
        <br />
        <div class="search-bar">
            <input type="text" pInputText placeholder="" [(ngModel)]="textoBuscar" (keyup.enter)="buscar()"
                class="mr-3 w-5" />
            <p-button pButton type="button" label="Buscar" icon="pi pi-search" class="p-ml-2" style="height: 35px;"
                (click)="buscar()"></p-button>
        </div>
        <b class="">* digitar ruc, razon social, nro doc</b>
    </p-panel>
    <br />
    <div class="card p-2">
        <p-table [value]="traerHistoricoList" [scrollable]="true"
            [tableStyle]="{width: '100%', border: '0px solid black'}" [loading]="load">
            <ng-template pTemplate="header">
                <tr>
                    <th style="text-align: center;">RUC</th>
                    <th style="text-align: center;">Razon Social</th>
                    <th style="text-align: center;">Tip.Doc</th>
                    <th style="text-align: center;">Numero</th>
                    <th style="text-align: center;">Fecha</th>
                    <th style="text-align: center;">Imp.Fact</th>
                    <th style="text-align: center;">Moneda</th>
                    <th style="text-align: center;">Fec.Pago</th>
                    <th style="text-align: center;">Pago S/.</th>
                    <th style="text-align: center;">Pago $</th>
                    <th style="text-align: center;">Saldo</th>
                    <th style="text-align: center;">Estado</th>
                    <th style="text-align: center;">Sustentos</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-doc>
                <tr>
                    <td style="text-align: center; white-space: nowrap;">{{ doc.ruc }}</td>
                    <td style="text-align: left; white-space: nowrap;">{{ doc.razonSocial }}</td>
                    <td style="text-align: center; white-space: nowrap;">{{ doc.tipoDocDesc }}</td>
                    <td style="text-align: center; white-space: nowrap;">{{ doc.nroComprobante }}</td>
                    <td style="text-align: center; white-space: nowrap;">{{ doc.fecha }}</td>
                    <td style="text-align: right; white-space: nowrap;">{{ doc.importeFactura | number : "1.1-2"}}</td>
                    <td style="text-align: center; white-space: nowrap;">{{ doc.monedaFactura }}</td>
                    <td style="text-align: center; white-space: nowrap;">{{ doc.fechapago }}</td>
                    <td style="text-align: right; white-space: nowrap;">{{ doc.importePagoSoles | number : "1.1-2" }}</td>
                    <td style="text-align: right; white-space: nowrap;">{{ doc.importePagoDolares | number : "1.1-2" }}</td>
                    <td style="text-align: right; white-space: nowrap;">{{ doc.saldo | number:"1.1-2" }}</td>
                    <td style="text-align: center; white-space: nowrap;">
                        <p-tag 
                            [severity]="doc.estadopago === 'Pendiente' ? 'danger' : (doc.estadopago === 'Cobrado' ? 'info' : 
                            (doc.estadopago === 'Parcial' ? 'warning' : 'secondary'))">
                            {{ doc.estadopago }}
                        </p-tag>                        
                    </td>
                    <td style="text-align: center; white-space: nowrap;">
                        <!-- Botón activo: Cobrado/Pagado CON numeroRegCobro -->
                        <p-button 
                            *ngIf="tieneSustentosDisponibles(doc)" 
                            icon="pi pi-file"
                            styleClass="p-button-sm p-button-info"
                            (onClick)="abrirModalSustentos(doc)"
                            [pTooltip]="'Ver sustentos - Reg: ' + doc.numeroRegCobro"
                            tooltipPosition="left"
                            [text]="false">
                        </p-button>
                        
                        <!-- Botón deshabilitado: Sin sustentos disponibles -->
                        <p-button 
                            *ngIf="!tieneSustentosDisponibles(doc)" 
                            icon="pi pi-file-excel"
                            styleClass="p-button-sm p-button-danger"
                            [disabled]="true"
                            [pTooltip]="doc.estadopago === 'Pendiente' || doc.estadopago === 'Parcial' 
                                ? 'Sin sustentos - Estado: ' + doc.estadopago 
                                : 'Sin registro de cobro asociado'"
                            tooltipPosition="left"
                            [text]="false">
                        </p-button>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="13" style="text-align: center; font-weight: bold; padding: 1rem;">
                        {{ searchPerformed ? 'No se encontraron registros' : 'Realice una búsqueda para ver resultados' }}
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

<!-- Modal para mostrar los sustentos -->
<p-dialog 
    [(visible)]="displayModalSustentos"  
    [modal]="true" 
    header="Sustento Adjunto"  
    [style]="{ width: '70vw', maxHeight: '80vh' }" 
    [draggable]="false" 
    [resizable]="false" 
    [maximizable]="true" 
    [baseZIndex]="10000"
    (onHide)="cerrarModalSustentos()">
    
    <div class="modal-content">
        <!-- Información del registro -->
        <div class="p-3 mb-3" style="background-color: #f8f9fa; border-radius: 5px;">
            <div class="grid">
                <div class="col-4">
                    <strong>RUC:</strong> {{ registroSeleccionado?.ruc }}
                </div>
                <div class="col-8">
                    <strong>Razón Social:</strong> {{ registroSeleccionado?.razonSocial }}
                </div>
                <div class="col-4">
                    <strong>Nro. Documento:</strong> {{ registroSeleccionado?.nroComprobante }}
                </div>
                <div class="col-4">
                    <strong>Fecha:</strong> {{ registroSeleccionado?.fecha }}
                </div>
                <div class="col-4">
                    <strong>Estado:</strong> 
                    <p-tag 
                        [severity]="registroSeleccionado?.estadopago === 'Cobrado' ? 'info' : 'success'"
                        class="ml-2">
                        {{ registroSeleccionado?.estadopago }}
                    </p-tag>
                </div>
                
                <!-- Información del registro de cobro -->
                <div class="col-12" *ngIf="registroSeleccionado?.numeroRegCobro">
                    <div style="background-color: #d1ecf1; padding: 0.75rem; border-radius: 4px; border-left: 4px solid #0c5460; margin-top: 0.5rem;">
                        <i class="pi pi-info-circle mr-2" style="color: #0c5460;"></i>
                        <strong style="color: #0c5460;">Número de Registro de Cobro:</strong>
                        <span style="color: #0c5460; font-family: monospace; font-weight: bold;"> {{ registroSeleccionado.numeroRegCobro }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de sustentos -->
        <p-table 
            [value]="listaSustentos" 
            [scrollable]="true" 
            scrollHeight="400px"
            [loading]="loadingSustentos"
            styleClass="p-datatable-sm">
            
            <ng-template pTemplate="header">
                <tr>
                    <th style="width: 50%; text-align: left;">Nombre de Archivo</th>
                    <th style="width: 40%; text-align: left;">Descripción</th>
                    <th style="width: 10%; text-align: center;">Acciones</th>
                </tr>
            </ng-template>

            <ng-template pTemplate="body" let-sustento>
                <tr>
                    <td style="text-align: left;">
                        <i class="pi pi-file mr-2" style="color: #2196F3;"></i>
                        {{ sustento.ban05NombreArchivo }}
                    </td>
                    <td style="text-align: left;">
                        {{ sustento.ban05DescripcionArchivo || 'Sin descripción' }}
                    </td>
                    <td style="text-align: center;">
                        <p-button 
                            icon="pi pi-eye" 
                            styleClass="p-button-info p-button-sm"
                            (onClick)="abrirDocumentoSustento(sustento)"
                            pTooltip="Ver documento"
                            tooltipPosition="left"
                            [text]="false">
                        </p-button>
                    </td>
                </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="3" style="text-align: center; padding: 2rem;">
                        <i class="pi pi-info-circle" style="font-size: 2rem; color: #9E9E9E;"></i>
                        <p class="mt-3 mb-0" style="color: #757575;">No hay archivos de sustento disponibles</p>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <ng-template pTemplate="footer">
        <p-button 
            label="Cerrar" 
            icon="pi pi-times" 
            styleClass="p-button-text"
            (onClick)="cerrarModalSustentos()">
        </p-button>
    </ng-template>
</p-dialog>