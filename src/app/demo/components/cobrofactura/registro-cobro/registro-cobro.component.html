<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="container"> 
    <p-panel header="Lista de Pagos" class="mb-3">
        <p-breadcrumb [model]="items" class="max-w-full;"></p-breadcrumb>
    </p-panel>
    <br />
    <div class="card">
        <div class="flex justify-content-between align-items-center mb-3">
            <p-button label="Nuevo" icon="pi pi-plus" (onClick)="iniciarNuevoRegistro()" [disabled]="mostrarNuevaFila" />
            
            <div class="flex align-items-center">
                <label for="rowsPerPage" class="mr-2">Filas por p치gina:</label>
                <p-dropdown id="rowsPerPage" 
                [options]="[10, 20, 40]" 
                [(ngModel)]="rowsPerPage" 
                placeholder="Seleccionar" 
                class="p-button-sm"></p-dropdown>
            </div>
        </div>
        <p-table [value]="listaRegistroCobro" [scrollable]="true" 
        [loading]="loading" [globalFilterFields]="['ban03numero', 'clienteNombre', 'clienteCodigo']" 
        [rows]="rowsPerPage" [paginator]="true" 
        [tableStyle]="{ width: '100%', border: '0px solid black' }">
            <ng-template pTemplate="header">
                <tr>
                    <th>
                        Codigo
                        <br />
                        <p-columnFilter 
                            type="text" 
                            field="ban03numero" 
                            placeholder="Buscar c칩digo" 
                            [showMenu]="false" 
                            matchMode="contains">
                        </p-columnFilter>
                    </th>
                    <th class="col-ruc">
                        RUC/C칩digo
                        <br />
                        <p-columnFilter 
                            type="text" 
                            field="clienteCodigo" 
                            placeholder="Buscar RUC" 
                            [showMenu]="false" 
                            matchMode="contains">
                        </p-columnFilter>
                    </th>
                    <th class="col-cliente">
                        Cliente
                        <br />
                        <p-columnFilter 
                            type="text" 
                            field="clienteNombre" 
                            placeholder="Buscar cliente" 
                            [showMenu]="false" 
                            matchMode="contains">
                        </p-columnFilter>
                    </th>
                    <th>Fec.Deposito</th>
                    <th class="col-moneda">Moneda</th>
                    <th>Importe</th>
                    <th class="col-mediopago">MedioPago</th>
                    <th>Motivo</th>
                    <th>Acciones</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-regcobro>
                <tr>
                    <td>             
                        {{regcobro.ban03numero}}
                    </td>
                    <td>
                        {{regcobro.clienteCodigo}}
                    </td>
                    <td class="col-cliente">
                        {{regcobro.clienteNombre}}
                    </td>
                    <td>
                        {{regcobro.ban03FechaDeposito}}
                    </td>
                    <td class="col-moneda">
                        <ng-container *ngIf="!editingRegCobro[regcobro.ban03numero] else monedaEditMode">
                            {{
                                regcobro.ban03Moneda === 'S' ? 'Soles' :
                                regcobro.ban03Moneda === 'D' ? 'D칩lares' : ''
                            }}
                        </ng-container>
                        <ng-template #monedaEditMode>
                            <p-dropdown [options]="monedaOpciones" [(ngModel)]="editaFormulario.ban03Moneda"
                                placeholder="Seleccionar moneda" optionLabel="label" optionValue="value"
                                appendTo="body" class="p-inputtext-sm w-full">
                            </p-dropdown>
                        </ng-template>
                    </td>
                    <td style="width: 100px; max-width: 100px;">
                        <ng-container *ngIf="!editingRegCobro[regcobro.ban03numero] else importeEditMode">
                            {{regcobro.ban03Importe}}
                        </ng-container>
                        <ng-template #importeEditMode>
                            <input pInputText type="number" [(ngModel)]="editaFormulario.ban03Importe"
                             class="w-full" />
                        </ng-template>
                    </td>

                    <td class="col-mediopago">
                        <ng-container *ngIf="!editingRegCobro[regcobro.ban03numero] else medioPagoEditMode">
                           {{regcobro.medioPagoDescripcion}}
                        </ng-container>
                        
                        <ng-template #medioPagoEditMode>
                            <p-dropdown [options]="medioPagoLista" [(ngModel)]="editaFormulario.ban03MedioPago"
                                placeholder="Seleccionar medio de pago" 
                                optionLabel="ban01Descripcion" optionValue="ban01IdTipoPago" 
                                appendTo="body" class="p-inputtext-sm w-full">
                            </p-dropdown>
                        </ng-template>
                    </td>

                    <td style="width: 100px; max-width: 100px;">
                        <ng-container *ngIf="!editingRegCobro[regcobro.ban03numero] else motivoEditMode">
                           {{regcobro.ban03Motivo}}
                        </ng-container>
                        <ng-template #motivoEditMode> 
                            <input pInputText [(ngModel)]="editaFormulario.ban03Motivo" placeholder="Motivo"
                                class="w-full" />
                        </ng-template>
                    </td>

                    <td>
                        <ng-container *ngIf="!editingRegCobro[regcobro.ban03numero] else editMode">
                            <p-button icon="pi pi-eye" styleClass="p-button-info p-button-sm"
                                        pTooltip="Ver Detalles" [text]="true" (onClick)="verDetalles(regcobro, false)"
                                        [disabled]="botonesDeshabilitados">
                            </p-button>

                            <p-button 
                                icon="pi pi-pencil" styleClass="p-button-text p-button-sm"
                                (onClick)="iniciarEdicion(regcobro)" 
                                [disabled]="botonesDeshabilitados"
                                pTooltip="Modificar" [text]="true">
                            </p-button>

                            <p-button 
                                icon="pi pi-trash" 
                                styleClass="p-button-danger p-button-sm" 
                                (click)="eliminarPago(regcobro)"
                                [text]="true"
                                pTooltip="Eliminar"
                                [disabled]="botonesDeshabilitados">
                            </p-button>
                        </ng-container>

                        <ng-container *ngIf="editingRegCobro[regcobro.ban03numero]">
                            <p-button icon="pi pi-check" styleClass="p-button-success p-button-sm" [text]="true"
                                (onClick)="guardarEdicion(regcobro.ban03numero)" 
                                pTooltip="Actualizar">
                            </p-button>
                            <p-button icon="pi pi-times" styleClass="p-button-danger p-button-sm" [text]="true"
                                (onClick)="cancelarEdicion(regcobro.ban03numero)" 
                                pTooltip="Cancelar">
                            </p-button>
                        </ng-container>                     
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="footer">
                <tr *ngIf="mostrarNuevaFila">
                    <td style="min-width: 100px">
                        {{ nuevoFormulario.ban03Numero }}
                    </td>
                    <td>
                        <p-dropdown [options]="listaClientes" 
                            optionLabel="codigoCliente"
                            optionValue="codigoCliente" 
                            [(ngModel)]="nuevoFormulario.ban03clienteruc"
                            class="p-inputtext-sm w-full" 
                            (onChange)="onClienteRucChange($event)" 
                            [filter]="true"
                            filterBy="codigoCliente" 
                            filterMatchMode="contains" 
                            placeholder="RUC" 
                            appendTo="body">
                        </p-dropdown>
                    </td>
                    <td class="col-cliente">
                        <p-dropdown [options]="listaClientes" 
                            optionLabel="nombreCliente"
                            optionValue="codigoCliente" 
                            [(ngModel)]="nuevoFormulario.ban03clienteruc"
                            class="p-inputtext-sm w-full" 
                            (onChange)="onMedioChange($event)" 
                            [filter]="true"
                            filterBy="nombreCliente" 
                            filterMatchMode="contains" 
                            placeholder="cliente" 
                            appendTo="body">
                        </p-dropdown>
                    </td>

                    <td style="min-width: 130px">
                         <ng-container>
                            <p-calendar [(ngModel)]="nuevoFormulario.ban03FechaDeposito" 
                                dateFormat="dd/mm/yy" placeholder="Fecha"
                                (onSelect)="actualizarFechaEdicion($event)" 
                                [showIcon]="true" appendTo="body"
                                class="w-full"></p-calendar>
                         </ng-container>
                    </td>
                     <td class="col-moneda">
                            <ng-container >
                                <p-dropdown [options]="monedaOpciones" 
                                    [(ngModel)]="nuevoFormulario.ban03moneda"
                                    placeholder="Seleccionar moneda" 
                                    optionLabel="label" 
                                    optionValue="value"
                                    appendTo="body" 
                                    class="p-inputtext-sm w-full">
                                </p-dropdown>
                            </ng-container>
                    </td>
                    
                    <td style="min-width: 80px">
                        <ng-container>
                            <input pInputText [(ngModel)]="nuevoFormulario.ban03Importe"
                                   placeholder="Ingresar importe"
                                   class="w-full">
                        </ng-container>
                    </td>
                    <td class="col-mediopago">
                         <ng-container>
                            <p-dropdown [options]="medioPagoLista"
                                [(ngModel)]="nuevoFormulario.ban03MedioPago"
                                placeholder="seleccione medio pago"
                                optionLabel="ban01Descripcion"
                                optionValue="ban01IdTipoPago"
                                appendTo="body"
                                class="p-inputtext-sm w-full"
                            ></p-dropdown>
                         </ng-container>
                    </td>
                    <td style="min-width: 150px">
                          <input pInputText [(ngModel)]="nuevoFormulario.ban03Motivo"
                                   placeholder="Ingresar motivo"
                                   class="w-full">
                    </td>                  
                    <td>                 
                        <div class="flex gap-2">
                            <p-button icon="pi pi-check" styleClass="p-button-success p-button-sm" [text]="true"
                                (onClick)="guardarNuevo()" pTooltip="Guardar"></p-button>
                            <p-button icon="pi pi-times" styleClass="p-button-danger p-button-sm" [text]="true"
                                (onClick)="cancelarNuevo()" pTooltip="Cancelar"></p-button>
                        </div>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="9" style="text-align: center; font-weight: bold; padding: 1rem;">
                        No se encontraron registros
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>