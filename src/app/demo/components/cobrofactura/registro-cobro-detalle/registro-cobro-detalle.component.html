<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<!-- Input file oculto para seleccionar archivos -->
<input #fileInput type="file" multiple style="display: none;" 
       (change)="onFileSelected($event)" 
       accept=".pdf,.png,.jpg,.jpeg,.doc,.docx,.xls,.xlsx" />

<div class="container">
    <p-panel header="Detalle de Registro de Cobro" class="mb-3">
        <p-breadcrumb [model]="items" class="max-w-full;"></p-breadcrumb>
    </p-panel>
    <br>
    
    <!-- Información General -->
    <div class="card p-2">
        <div style="display: flex; width: 100%; margin-bottom: 1rem; gap: 20px;">
            <div style="flex: 1;">
                <label for="cobro-nro" class="text-sm">Cobro Nro: </label>
                <input pInputText id="cobro-nro" [value]="cobroNro" [disabled]="true"
                    style="width: 100%; height: 2.5rem;" />
            </div>

            <div style="flex: 1;">
                <label for="fecha" class="text-sm">Fecha: </label>
                <p-calendar [disabled]="true" [(ngModel)]="fecha" style="width: 100%; height: 2.5rem;"
                    inputStyleClass="p-input-sm" dateFormat="dd/mm/yy"></p-calendar>
            </div>

            <div style="flex: 1;">
                <label for="ruc" class="text-sm">RUC/Código: </label>
                <input pInputText id="ruc" [value]="clienteCodigo" [disabled]="true"
                    style="width: 100%; height: 2.5rem;" />
            </div>

            <div style="flex: 2;">
                <label for="cliente" class="text-sm">Cliente: </label>
                <input pInputText id="cliente" [value]="clienteNombre" [disabled]="true"
                    style="width: 100%; height: 2.5rem;" />
            </div>
        </div>
    </div>

    <!-- CONTENEDOR FLEX PARA LAS DOS TABLAS -->
    <div class="flex gap-3">
        <!-- Tabla 1: Facturas Afectadas -->
        <div class="card p-2 flex-1">
            <div class="flex justify-content-between align-items-center mb-2">
                <h3 class="m-0">FACTURAS AFECTADAS</h3>
                <p-button label="Nuevo" icon="pi pi-plus" styleClass="p-button-sm" 
                          (onClick)="agregarNuevaFactura()"
                          [disabled]="isAnyRowEditing"></p-button>
            </div>
            <p-table [value]="facturasAfectadas" styleClass="tabla-facturas" [scrollable]="true" scrollHeight="300px" [loading]="load">
                <ng-template pTemplate="header">
                    <tr>
                        <th>Numero</th>
                        <th>Fecha</th>
                        <th>Moneda</th>
                        <th>Importe Original</th>
                        <th>Importe Pagado</th>
                        <th>Observaciones</th>
                        <th>Acciones</th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-factura>
                    <tr>
                        <td>{{ factura.numero }}</td>
                        <td>{{ factura.fecha | date:'dd/MM/yyyy' }}</td>
                        <td>{{ factura.moneda }}</td>
                        <td style="text-align: right;">{{ factura.importeOriginal | number:'1.2-2' }}</td>
                        <td style="text-align: right;">
                            <ng-container *ngIf="editingFactura?.numero === factura.numero; else viewPagado">
                                <input pInputText type="number" [(ngModel)]="editingFactura.importePagado" 
                                       style="width: 100%; text-align: right;" />
                            </ng-container>
                            <ng-template #viewPagado>{{ factura.importePagado | number:'1.2-2' }}</ng-template>
                        </td>
                        <td>
                            <ng-container *ngIf="editingFactura?.numero === factura.numero; else viewObs">
                                <input pInputText [(ngModel)]="editingFactura.observaciones" 
                                       style="width: 100%;" />
                            </ng-container>
                            <ng-template #viewObs>{{ factura.observaciones }}</ng-template>
                        </td>
                        <td>
                            <div class="flex gap-2 justify-content-center">
                                <ng-container *ngIf="editingFactura?.numero === factura.numero; else editButtons">
                                    <p-button icon="pi pi-check" styleClass="p-button-success p-button-sm"
                                        (onClick)="saveEditingFactura()" pTooltip="Guardar" [text]="true"></p-button>
                                    <p-button icon="pi pi-times" styleClass="p-button-danger p-button-sm"
                                        (onClick)="cancelEditingFactura()" pTooltip="Cancelar" [text]="true"></p-button>
                                </ng-container>
                                <ng-template #editButtons>
                                    <p-button icon="pi pi-pencil" styleClass="p-button-text p-button-sm"
                                        (onClick)="startEditingFactura(factura)" [disabled]="isAnyRowEditing"
                                        pTooltip="Modificar" [text]="true"></p-button>
                                    <p-button icon="pi pi-trash" styleClass="p-button-danger p-button-sm"
                                        [disabled]="isAnyRowEditing" pTooltip="Eliminar" [text]="true"
                                        (onClick)="eliminarFactura(factura)"></p-button>
                                </ng-template>
                            </div>
                        </td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="footer">
                    <tr>
                        <td colspan="3" style="text-align: left;" class="font-bold">Totales:</td>
                        <td class="font-bold" style="text-align: right;">
                            {{ getTotalFacturas('importeOriginal') | number:'1.2-2' }}
                        </td>
                        <td class="font-bold" style="text-align: right;">
                            {{ getTotalFacturas('importePagado') | number:'1.2-2' }}
                        </td>
                        <td colspan="2"></td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="7" style="text-align: center; font-weight: bold; padding: 1rem;">
                            No se encontraron facturas
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>

        <!-- Tabla 2: Sustento Adjunto -->
        <div class="card p-2 flex-1">
            <div class="flex justify-content-between align-items-center mb-2">
                <h3 class="m-0">SUSTENTO ADJUNTO</h3>
                <p-button label="Nuevo" icon="pi pi-plus" styleClass="p-button-sm" 
                          (onClick)="agregarNuevoSustento()"
                          [disabled]="isAnyRowEditing"></p-button>
            </div>

            <p-table [value]="listaSustentos" styleClass="tabla-sustentos" [scrollable]="true" scrollHeight="300px" [loading]="load">
                <ng-template pTemplate="header">
                    <tr>
                        <th style="text-align: center !important; ">Nombre de Archivo</th>
                        <th style="text-align: center !important;">Descripción</th>
                        <th style="text-align: center !important;">Acciones</th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-sustento>
                    <tr>
                        <td style="width: 200px; max-width: 200px;">{{ sustento.ban05NombreArchivo }}</td>
                        <td style="width: 200px; max-width: 200px;">
                            <ng-container *ngIf="editingSustento?.ban05NombreArchivo === sustento.ban05NombreArchivo; 
                                else viewDesc">
                                <input pInputText [(ngModel)]="editingSustento.ban05DescripcionArchivo" 
                                style="width: 100%;" />
                            </ng-container>
                            <ng-template #viewDesc>{{ sustento.ban05DescripcionArchivo }}</ng-template>
                        </td>
                        <td>
                            <div class="flex gap-2 justify-content-center">
                                <ng-container *ngIf="editingSustento?.ban05NombreArchivo === sustento.ban05NombreArchivo; 
                                    else editButtons2">
                                    <p-button icon="pi pi-check" styleClass="p-button-success p-button-sm"
                                        (onClick)="saveEditingSustento()" pTooltip="Guardar" [text]="true"></p-button>
                                    <p-button icon="pi pi-times" styleClass="p-button-danger p-button-sm"
                                        (onClick)="cancelEditingSustento()" pTooltip="Cancelar" [text]="true"></p-button>
                                </ng-container>
                                <ng-template #editButtons2>
                                    <p-button icon="pi pi-eye" styleClass="p-button-info p-button-sm"
                                        (onClick)="abrirdocumento(sustento)" pTooltip="Ver" [text]="true"></p-button>
                                    <p-button icon="pi pi-pencil" styleClass="p-button-text p-button-sm"
                                        (onClick)="startEditingSustento(sustento)" [disabled]="isAnyRowEditing"
                                        pTooltip="Modificar" [text]="true"></p-button>
                                    <p-button icon="pi pi-trash" styleClass="p-button-danger p-button-sm"
                                        [disabled]="isAnyRowEditing" pTooltip="Eliminar" [text]="true"
                                        (onClick)="eliminarSustento(sustento)"></p-button>
                                </ng-template>
                            </div>
                        </td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="3" style="text-align: center; font-weight: bold; padding: 1rem;">
                            No se encontraron sustentos adjuntos
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>
    
</div>

<!-- Modal para agregar facturas -->
<p-dialog 
    [(visible)]="displayModal"  
    [modal]="true" 
    header="Seleccionar Facturas"  
    [style]="{ width: '90vw', height: 'auto' }" 
    [draggable]="false" 
    [resizable]="false" 
    [maximizable]="true" 
    [baseZIndex]="10000"
    (onHide)="onCloseModal()">
    
    <app-agrega-facturaxcobrar 
        [codigoCliente]="clienteCodigo"
        [nombreCliente]="clienteNombre"
        [cobroNro]="cobroNro"
        [empresa]="empresa"
        (xmlGenerado)="onFacturasSeleccionadas($event)"
        (onClose)="onCloseModal()">
    </app-agrega-facturaxcobrar>
</p-dialog>